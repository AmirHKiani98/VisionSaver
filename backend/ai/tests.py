from django.test import TestCase
from .car_detection import CarDetection
from django.conf import settings
from ultralytics import YOLO
import os
import cv2
import logging
from django.conf import settings
from ai.models import DetectionLines
from record.models import Record
logging.getLogger('ultralytics').setLevel(logging.WARNING)
class AiAppTestCase(TestCase):
    """
    Template test case for the 'ai' Django app.
    """
    def setUp(self):
        """
        Set up the test case with necessary configurations.
        """
        self.record_id = 673
    
        video_input = f"{self.record_id}.mkv"
        self.video_path = os.path.join(settings.MEDIA_ROOT, video_input)
        if not os.path.isfile(self.video_path):
            raise FileNotFoundError(f"Test video file not found at {self.video_path}")
        # Ensure the video file is accessiblea
        self.output_dir = os.path.join(os.path.dirname(__file__), 'test')
        self.assertTrue(os.path.isfile(self.video_path), f"Video file not found at {self.video_path}")

    def test_video_image(self):        
        return
        # Load YOLOv8 model
        model = YOLO('yolov8n.pt', verbose=False)
        detector = CarDetection(
            model=model,
            video_path=self.video_path,
            divide_time=0.1
        )
        detector.get_results_from_video(divide_time)

        
        
        

        # Check if the file exists
        objects_df = detector.results_df
        self.assertIsNotNone(objects_df, "Results DataFrame is None")
        self.assertGreater(len(objects_df), 0, "No objects detected in the video") # type: ignore
        os.makedirs(self.output_dir, exist_ok=True)
        # objects_df.to_csv(os.path.join(settings.MEDIA_ROOT, str(hash(os.path.basename(self.video_path))) + '.csv'), index=False) # type: ignore
        self.play_annotated_video(objects_df)
        
        
    # def test_play_annotated_video(self):
    #     # Test playing the annotated video
    #     with open(os.path.join(self.output_dir, 'car_detection_results.json'), 'r') as f:
    #         detector = json.load(f)
    #     self.play_annotated_video(detector)

    def play_annotated_video(self, objects_df, fps=10):
        delay = int(1000 / fps)
        objects_df = objects_df.copy()
        objects_df = objects_df.sort_values(by='time')
        cap = cv2.VideoCapture(self.video_path)
        last_frame_number = None
        group_by_time = objects_df.groupby(['time', 'frame_number'])
        for names, group in group_by_time:
            timestamp, frame_number = names
            
            # print(f"Processing timestamp: {timestamp}")
            # Only seek if not the next frame
            if last_frame_number is None or frame_number != last_frame_number + 1:
                cap.set(cv2.CAP_PROP_POS_FRAMES, frame_number)
            success, frame = cap.read()
            if not success:
                continue
            frame = self.draw_detections(frame, group)
            cv2.imshow('Annotated Video', frame)
            if cv2.waitKey(delay) & 0xFF == ord('q'):
                break
            last_frame_number = frame_number
        cap.release()
        cv2.destroyAllWindows()

    def draw_detections(self, frame, objects):
        for index, row in objects.iterrows():
            x1, y1 = int(row['x1']), int(row['y1'])
            x2, y2 = int(row['x2']), int(row['y2'])
            track_id = row['track_id'] if 'track_id' in row else 0

            cv2.rectangle(frame, (x1, y1), (x2, y2), (0, 255, 0), 2)
            cv2.putText(frame, f"ID:{track_id}", (x1, y1 - 10),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 255, 0), 2)
        return frame
    
    def test_drawlines(self):
        
        cap = cv2.VideoCapture(self.video_path)
        lines = {"vehicle_delay_rect": [{"tool": "pen", "points": [0.035367601853523355, 0.26048838719055967, 0.03690532367324176, 0.26048838719055967, 0.046131654591552204, 0.26048838719055967, 0.05228254187042583, 0.26048838719055967, 0.056895707329581054, 0.26048838719055967, 0.06150887278873626, 0.26048838719055967, 0.06612203824789148, 0.26048838719055967, 0.07073520370704671, 0.26048838719055967, 0.07381064734648352, 0.26048838719055967, 0.08149925644507555, 0.26048838719055967, 0.08611242190423078, 0.26048838719055967, 0.08918786554366759, 0.2577559913749487, 0.09380103100282282, 0.2577559913749487, 0.09533875282254121, 0.2577559913749487, 0.10148964010141485, 0.2550235955593378, 0.10456508374085166, 0.2550235955593378, 0.10764052738028848, 0.2550235955593378, 0.11071597101972529, 0.2550235955593378, 0.1168668582985989, 0.2550235955593378, 0.12148002375775413, 0.2550235955593378, 0.12609318921690935, 0.2550235955593378, 0.12916863285634617, 0.2550235955593378, 0.13378179831550138, 0.2550235955593378, 0.1383949637746566, 0.2577559913749487, 0.14300812923381184, 0.2577559913749487, 0.14762129469296703, 0.2577559913749487, 0.15069673833240385, 0.2577559913749487, 0.15377218197184067, 0.2577559913749487, 0.1583853474309959, 0.26048838719055967, 0.16146079107043268, 0.26048838719055967, 0.16607395652958792, 0.26048838719055967, 0.16914940016902474, 0.26048838719055967, 0.17376256562817996, 0.26322078300617063, 0.17683800926761675, 0.26322078300617063, 0.181451174726772, 0.26322078300617063, 0.1860643401859272, 0.2659531788217816, 0.18913978382536403, 0.2659531788217816, 0.19682839292395607, 0.2686855746373925, 0.19990383656339286, 0.2714179704530035, 0.2029792802028297, 0.2714179704530035, 0.20913016748170332, 0.2714179704530035, 0.21528105476057696, 0.2714179704530035, 0.21835649840001375, 0.2741503662686144, 0.22296966385916897, 0.27688276208422535, 0.22758282931832421, 0.27688276208422535, 0.23219599477747943, 0.27688276208422535, 0.2398846038760714, 0.27688276208422535, 0.24296004751550826, 0.2796151578998363, 0.24757321297466348, 0.2796151578998363, 0.2506486566141003, 0.2796151578998363, 0.25526182207325554, 0.28234755371544723, 0.25833726571269233, 0.28234755371544723, 0.2614127093521291, 0.28234755371544723, 0.2644881529915659, 0.28234755371544723, 0.2644881529915659, 0.28234755371544723, 0.26910131845072116, 0.28234755371544723, 0.27063904027043956, 0.28234755371544723, 0.2737144839098764, 0.28234755371544723, 0.2737144839098764, 0.28234755371544723, 0.2783276493690316, 0.2850799495310582, 0.27986537118875005, 0.2850799495310582, 0.2814030930084684, 0.2850799495310582, 0.2860162584676237, 0.2850799495310582, 0.2890917021070605, 0.2850799495310582, 0.2906294239267789, 0.2850799495310582, 0.29216714574649727, 0.2850799495310582, 0.29370486756621567, 0.28781234534666916, 0.29524258938593406, 0.28781234534666916, 0.2998557548450893, 0.28781234534666916, 0.2998557548450893, 0.2905447411622801, 0.3013934766648077, 0.2905447411622801, 0.3013934766648077, 0.293277136977891, 0.3013934766648077, 0.293277136977891, 0.30293119848452615, 0.2987419286091129, 0.30293119848452615, 0.3042067202403348, 0.30293119848452615, 0.31240390768716764, 0.30293119848452615, 0.3151363035027786, 0.30293119848452615, 0.3206010951340005, 0.30293119848452615, 0.3206010951340005, 0.30293119848452615, 0.3260658867652224, 0.30293119848452615, 0.33153067839644423, 0.30293119848452615, 0.3342630742120552, 0.30293119848452615, 0.33699547002766617, 0.30293119848452615, 0.34246026165888804, 0.30293119848452615, 0.345192657474499, 0.30293119848452615, 0.3479250532901099, 0.30293119848452615, 0.3479250532901099, 0.30293119848452615, 0.3533898449213318, 0.30446892030424455, 0.35885463655255373, 0.30446892030424455, 0.35885463655255373, 0.30446892030424455, 0.3643194281837756, 0.30446892030424455, 0.36978421981499754, 0.30446892030424455, 0.36978421981499754, 0.30600664212396295, 0.37524901144621936, 0.30600664212396295, 0.37524901144621936, 0.30600664212396295, 0.38071380307744124, 0.30600664212396295, 0.38344619889305226, 0.30600664212396295, 0.38617859470866317, 0.30754436394368134, 0.38617859470866317, 0.30754436394368134, 0.39437578215549596, 0.30754436394368134, 0.397108177971107, 0.30754436394368134, 0.397108177971107, 0.30754436394368134, 0.40257296960232886, 0.30908208576339974, 0.4080377612335508, 0.30908208576339974, 0.4107701570491617, 0.30908208576339974, 0.4162349486803836, 0.30908208576339974, 0.4216997403116055, 0.30908208576339974, 0.4244321361272164, 0.30908208576339974, 0.4271645319428274, 0.30908208576339974, 0.4298969277584383, 0.30908208576339974, 0.4326293235740492, 0.30908208576339974, 0.43536171938966023, 0.30908208576339974, 0.4408265110208821, 0.31061980758311813, 0.4408265110208821, 0.31061980758311813, 0.443558906836493, 0.31061980758311813, 0.446291302652104, 0.31061980758311813, 0.446291302652104, 0.31061980758311813, 0.45175609428332586, 0.31215752940283653, 0.45722088591454774, 0.31215752940283653, 0.4599532817301587, 0.31215752940283653, 0.4626856775457696, 0.31215752940283653, 0.46541807336138064, 0.313695251222555, 0.46815046917699155, 0.313695251222555, 0.47088286499260246, 0.313695251222555, 0.4736152608082134, 0.313695251222555, 0.47634765662382433, 0.313695251222555, 0.47908005243943536, 0.313695251222555, 0.48181244825504627, 0.313695251222555, 0.48454484407065723, 0.313695251222555, 0.48454484407065723, 0.313695251222555, 0.48727723988626814, 0.313695251222555, 0.49000963570187905, 0.313695251222555, 0.49000963570187905, 0.313695251222555, 0.4927420315174901, 0.313695251222555, 0.495474427333101, 0.313695251222555, 0.49820682314871195, 0.313695251222555, 0.5009392189643229, 0.313695251222555, 0.5036716147799338, 0.313695251222555, 0.5064040105955447, 0.313695251222555, 0.5091364064111557, 0.313695251222555, 0.5118688022267667, 0.313695251222555, 0.5118688022267667, 0.313695251222555, 0.5146011980423776, 0.313695251222555, 0.5173335938579886, 0.313695251222555, 0.5200659896735995, 0.313695251222555, 0.5227983854892104, 0.31215752940283653, 0.5227983854892104, 0.31061980758311813, 0.5282631771204324, 0.30908208576339974, 0.5282631771204324, 0.30754436394368134, 0.5282631771204324, 0.30754436394368134, 0.5282631771204324, 0.30293119848452615, 0.5309955729360433, 0.2998557548450893, 0.5309955729360433, 0.2967803112056525, 0.5337279687516542, 0.29524258938593406, 0.5337279687516542, 0.2906294239267789, 0.5337279687516542, 0.287553980287342, 0.5337279687516542, 0.28447853664790523, 0.5337279687516542, 0.28294081482818684, 0.5337279687516542, 0.2767899275493132, 0.5337279687516542, 0.2737144839098764, 0.5337279687516542, 0.27063904027043956, 0.5337279687516542, 0.26756359663100276, 0.5337279687516542, 0.26756359663100276, 0.5337279687516542, 0.26602587481128437, 0.5337279687516542, 0.2629504311718476, 0.5364603645672652, 0.2614127093521291, 0.5364603645672652, 0.25987498753241073, 0.5391927603828761, 0.25526182207325554, 0.541925156198487, 0.2521863784338187, 0.544657552014098, 0.2506486566141003, 0.544657552014098, 0.24757321297466348, 0.544657552014098, 0.24296004751550826, 0.544657552014098, 0.24142232569578984, 0.544657552014098, 0.23680916023663462, 0.544657552014098, 0.23527143841691622, 0.544657552014098, 0.2337337165971978, 0.547389947829709, 0.2337337165971978, 0.5501223436453199, 0.22758282931832421, 0.5528547394609309, 0.22450738567888737, 0.5528547394609309, 0.22296966385916897, 0.5528547394609309, 0.22143194203945057, 0.5528547394609309, 0.21835649840001375, 0.5555871352765418, 0.21528105476057696, 0.5555871352765418, 0.2106678893014217, 0.5555871352765418, 0.2060547238422665, 0.5583195310921527, 0.20451700202254808, 0.5583195310921527, 0.2029792802028297, 0.5610519269077636, 0.19836611474367444, 0.5610519269077636, 0.19682839292395607, 0.5610519269077636, 0.19221522746480083, 0.5610519269077636, 0.18760206200564564, 0.5610519269077636, 0.181451174726772, 0.5610519269077636, 0.17837573108733518, 0.5610519269077636, 0.17837573108733518, 0.5610519269077636, 0.17683800926761675, 0.5610519269077636, 0.17222484380846156, 0.5610519269077636, 0.16914940016902474, 0.5610519269077636, 0.16761167834930632, 0.5610519269077636, 0.16607395652958792, 0.5610519269077636, 0.1629985128901511, 0.5610519269077636, 0.15992306925071428, 0.5610519269077636, 0.1568476256112775, 0.5610519269077636, 0.15530990379155907, 0.5610519269077636, 0.15377218197184067, 0.5610519269077636, 0.14915901651268546, 0.5610519269077636, 0.14762129469296703, 0.5610519269077636, 0.14454585105353024, 0.5583195310921527, 0.14300812923381184, 0.5583195310921527, 0.14147040741409342, 0.5583195310921527, 0.1383949637746566, 0.5583195310921527, 0.13531952013521978, 0.5583195310921527, 0.13224407649578296, 0.5583195310921527, 0.13224407649578296, 0.5583195310921527, 0.12916863285634617, 0.5583195310921527, 0.12763091103662777, 0.5583195310921527, 0.12301774557747253, 0.5583195310921527, 0.12148002375775413, 0.5583195310921527, 0.11840458011831731, 0.5583195310921527, 0.1168668582985989, 0.5583195310921527, 0.11225369283944368, 0.5583195310921527, 0.11071597101972529, 0.5583195310921527, 0.10764052738028848, 0.5583195310921527, 0.10764052738028848, 0.5583195310921527, 0.10456508374085166, 0.5583195310921527, 0.10148964010141485, 0.5583195310921527, 0.09841419646197803, 0.5583195310921527, 0.09533875282254121, 0.5583195310921527, 0.09380103100282282, 0.5583195310921527, 0.09226330918310441, 0.5583195310921527, 0.090725587363386, 0.5583195310921527, 0.08765014372394918, 0.5583195310921527, 0.08457470008451237, 0.5583195310921527, 0.08303697826479396, 0.5583195310921527, 0.07996153462535714, 0.5583195310921527, 0.07534836916620193, 0.5583195310921527, 0.07073520370704671, 0.5583195310921527, 0.07073520370704671, 0.5583195310921527, 0.0691974818873283, 0.5555871352765418, 0.06765976006760989, 0.5555871352765418, 0.06612203824789148, 0.5555871352765418, 0.06458431642817308, 0.5555871352765418, 0.06304659460845467, 0.5555871352765418, 0.06150887278873626, 0.5555871352765418, 0.06150887278873626, 0.5555871352765418, 0.05843342914929945, 0.5555871352765418, 0.056895707329581054, 0.5555871352765418, 0.05382026369014424, 0.5555871352765418, 0.05074482005070743, 0.5555871352765418, 0.04920709823098902, 0.5555871352765418, 0.046131654591552204, 0.5555871352765418, 0.046131654591552204, 0.5555871352765418, 0.044593932771833794, 0.5555871352765418, 0.04305621095211539, 0.5555871352765418, 0.04305621095211539, 0.5555871352765418, 0.04305621095211539, 0.5555871352765418, 0.04151848913239698, 0.5555871352765418, 0.03998076731267857, 0.5555871352765418, 0.03844304549296017, 0.5555871352765418, 0.03844304549296017, 0.5528547394609309, 0.03690532367324176, 0.5528547394609309, 0.035367601853523355, 0.5528547394609309, 0.033829880033804945, 0.5501223436453199, 0.03229215821408654, 0.5501223436453199, 0.03229215821408654, 0.547389947829709, 0.03229215821408654, 0.544657552014098, 0.03075443639436813, 0.544657552014098, 0.03075443639436813, 0.544657552014098, 0.03075443639436813, 0.541925156198487, 0.029216714574649725, 0.5391927603828761, 0.027678992754931322, 0.5337279687516542, 0.027678992754931322, 0.5309955729360433, 0.027678992754931322, 0.5282631771204324, 0.027678992754931322, 0.5255307813048214, 0.027678992754931322, 0.5227983854892104, 0.026141270935212915, 0.5146011980423776, 0.026141270935212915, 0.5118688022267667, 0.026141270935212915, 0.5091364064111557, 0.026141270935212915, 0.5064040105955447, 0.026141270935212915, 0.5036716147799338, 0.026141270935212915, 0.5009392189643229, 0.026141270935212915, 0.49820682314871195, 0.026141270935212915, 0.4927420315174901, 0.026141270935212915, 0.49000963570187905, 0.026141270935212915, 0.48181244825504627, 0.026141270935212915, 0.47908005243943536, 0.026141270935212915, 0.47634765662382433, 0.026141270935212915, 0.4736152608082134, 0.026141270935212915, 0.46815046917699155, 0.026141270935212915, 0.4626856775457696, 0.026141270935212915, 0.4599532817301587, 0.026141270935212915, 0.45722088591454774, 0.026141270935212915, 0.45175609428332586, 0.026141270935212915, 0.446291302652104, 0.026141270935212915, 0.446291302652104, 0.026141270935212915, 0.443558906836493, 0.026141270935212915, 0.43809411520527114, 0.026141270935212915, 0.43536171938966023, 0.026141270935212915, 0.4326293235740492, 0.026141270935212915, 0.4298969277584383, 0.026141270935212915, 0.4244321361272164, 0.026141270935212915, 0.4189673444959945, 0.026141270935212915, 0.4135025528647726, 0.026141270935212915, 0.4107701570491617, 0.026141270935212915, 0.4080377612335508, 0.026141270935212915, 0.40257296960232886, 0.026141270935212915, 0.3998405737867179, 0.026141270935212915, 0.397108177971107, 0.026141270935212915, 0.39164338633988505, 0.02460354911549451, 0.38891099052427414, 0.02460354911549451, 0.38617859470866317, 0.02460354911549451, 0.38071380307744124, 0.02460354911549451, 0.37524901144621936, 0.02460354911549451, 0.36978421981499754, 0.02460354911549451, 0.36978421981499754, 0.02460354911549451, 0.3643194281837756, 0.02460354911549451, 0.36158703236816464, 0.02460354911549451, 0.35885463655255373, 0.02460354911549451, 0.3533898449213318, 0.02460354911549451, 0.3533898449213318, 0.02460354911549451, 0.3479250532901099, 0.02460354911549451, 0.345192657474499, 0.02460354911549451, 0.3397278658432771, 0.02460354911549451, 0.33699547002766617, 0.02460354911549451, 0.33699547002766617, 0.02460354911549451, 0.33153067839644423, 0.02460354911549451, 0.3260658867652224, 0.02460354911549451, 0.3206010951340005, 0.02460354911549451, 0.3151363035027786, 0.02460354911549451, 0.3151363035027786, 0.02460354911549451, 0.30967151187155667, 0.02460354911549451, 0.30693911605594576, 0.02460354911549451, 0.3042067202403348, 0.02460354911549451, 0.2987419286091129, 0.02460354911549451, 0.2987419286091129, 0.02460354911549451, 0.29600953279350195, 0.02460354911549451, 0.293277136977891, 0.02460354911549451, 0.2905447411622801, 0.02460354911549451, 0.28781234534666916, 0.02460354911549451, 0.28781234534666916, 0.02460354911549451, 0.2850799495310582, 0.02460354911549451, 0.28234755371544723, 0.02460354911549451, 0.28234755371544723, 0.02460354911549451, 0.2796151578998363, 0.02460354911549451, 0.27688276208422535, 0.02460354911549451, 0.27688276208422535, 0.02460354911549451, 0.2741503662686144, 0.02460354911549451, 0.2714179704530035, 0.026141270935212915, 0.2714179704530035, 0.026141270935212915, 0.2714179704530035, 0.026141270935212915, 0.2686855746373925, 0.026141270935212915, 0.2659531788217816, 0.027678992754931322, 0.2659531788217816, 0.027678992754931322, 0.26322078300617063, 0.027678992754931322, 0.26048838719055967, 0.03075443639436813, 0.26048838719055967, 0.03075443639436813, 0.26048838719055967, 0.033829880033804945, 0.26048838719055967, 0.035367601853523355, 0.26048838719055967]}]}
        model = YOLO('yolov8n.pt', verbose=False)
        car_detection_obj = CarDetection(model, record_id=673, detection_lines=lines, divide_time=0.1)
        car_detection_obj.run()
        # car_detection_obj.draw_lines()
            
            